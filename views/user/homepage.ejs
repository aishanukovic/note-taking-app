<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>User Homepage</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/style.css">
        <style>
            body {
                background-color: #f8f9fa;
                color: #212529;
            }
        </style>
    </head>
    <body class="navbar-page">
        <%- include('../partials/navbar.ejs') %>

        <div class="container mt-5">        
            <h1>Welcome, <%= user.email %>!</h1>
            <p>Here is where you can access, modify, and create new notes.</p>
            <button id="createNoteButton" class="btn btn-primary mb-3">Create New Note</button>
            <button id="toggleView" class="btn btn-secondary mb-3">Change View</button>
            <button id="toggleTheme" class="btn btn-info mb-3">Change Theme</button>
            <button id="logoutButton" class="btn btn-danger mb-3">Logout</button>

            <div id="notesList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                <% notes.forEach(note => { %>
                    <div class="col">
                        <a href="/notes/<%= note.id %>" class="text-decoration-none">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title"><%= note.title %></h5>
                                    <p class="card-text">
                                        <%= note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content %>
                                    </p>
                                </div>
                                <div class="card-footer bg-light text-muted">
                                    <small>Created on: <%= note.createdAt ? new Date(note.createdAt).toLocaleString() : 'N/A' %></small>
                                </div>
                            </div>
                        </a>
                    </div>
                <% }) %>
            </div>                        

            <div id="collectionsView" class="collections-view" style="display:none;">
                <% let currentCollection = ''; %>
                <% notes.forEach(note => { %>
                    <% if (note.collection !== currentCollection) { %>
                        <div class="collection-header mt-4">
                            <h3 class="text-primary"><%= note.collection ? note.collection : 'Uncategorized' %></h3>
                        </div>
                        <% currentCollection = note.collection; %>
                    <% } %>
                    
                    <div class="col mb-4">
                        <a href="/notes/<%= note.id %>" class="text-decoration-none">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title"><%= note.title %></h5>
                                    <p class="card-text">
                                        <%= note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content %>
                                    </p>
                                </div>
                                <div class="card-footer bg-light text-muted">
                                    <small>Created on: <%= note.createdAt ? new Date(note.createdAt).toLocaleString() : 'N/A' %></small>
                                </div>
                            </div>
                        </a>
                    </div>
                <% }) %>
            </div>
                       
        </div>

        <%- include('../partials/footer.ejs') %>

        <script>
            console.log("JavaScript is loading properly!");
            document.getElementById('createNoteButton').addEventListener('click', function() {
                window.location.href = '/notes/create';
            });
            
            document.getElementById('logoutButton').addEventListener('click', function(event) {
                event.preventDefault();
                
                const userConfirmed = confirm('Are you sure you want to logout?');

                if (userConfirmed) {
                    window.location.href = '/auth/logout';
                }
            });

            document.getElementById('toggleView').addEventListener('click', function() {
                const listView = document.getElementById('notesList');
                const collectionsView = document.getElementById('collectionsView');

                if (listView.style.display === 'none') {
                    listView.style.display = 'block';
                    collectionsView.style.display = 'none';
                } else {
                    listView.style.display = 'none';
                    collectionsView.style.display = 'block';
                }
            });

            document.getElementById('toggleTheme').addEventListener('click', function() {
                const body = document.body;
                if (body.style.backgroundColor === 'rgb(248, 249, 250)') {
                    body.style.backgroundColor = '#343a40';
                    body.style.color = '#f8f9fa';
                } else {
                    body.style.backgroundColor = '#f8f9fa';
                    body.style.color = '#212529';
                }
            });
        </script>
    </body>
</html>